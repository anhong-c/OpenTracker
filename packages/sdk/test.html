<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/antd@4/dist/antd.min.css">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/antd@4/dist/antd.min.js"></script>

    
    <title>test page</title>
</head>
<body>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding:20px;
        }
        button{
            margin:10px;
            padding:10px 20px;
            font-size:16px;
            cursor:pointer;
            background-color: #1890ff;
            color:white;
            border:none;
            border-radius:4px;
        }
        button:hover{
            background-color: #40a9ff;
        }
    </style>
  <div id = "app">
    <h1>é”™è¯¯ç›‘æ§æµ‹è¯•</h1>
    <p>æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹æ•è·åˆ°çš„é”™è¯¯ä¿¡æ¯</p>
    <div>
        <button onclick="testError1()">æµ‹è¯• 1: æŠ›å‡ºæ™®é€šé”™è¯¯</button>
        <button onclick="testError2()">æµ‹è¯• 2: æŠ›å‡ºæœªæ•è·çš„Promiseé”™è¯¯</button>
        <button onclick="testError3()">æµ‹è¯• 3: è®¿é—®æœªå®šä¹‰å˜é‡</button>
        <button onclick="testError4()">æµ‹è¯• 4: è¯­æ³•é”™è¯¯ï¼ˆevalï¼‰</button>
    </div>
    
    <h2 style="margin-top: 30px;">API é”™è¯¯ç›‘æ§æµ‹è¯•</h2>
    <div>
        <button onclick="testApiError1()">æµ‹è¯• 1: 404 é”™è¯¯</button>
        <button onclick="testApiError2()">æµ‹è¯• 2: 500 é”™è¯¯</button>
        <button onclick="testApiError3()">æµ‹è¯• 3: ç½‘ç»œé”™è¯¯</button>
        <button onclick="testApiError4()">æµ‹è¯• 4: è¶…æ—¶é”™è¯¯</button>
    </div>
    <div id="errorLog" style="margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 4px; max-height: 300px; overflow-y: auto;">
        <h3>æ•è·åˆ°çš„é”™è¯¯ï¼ˆå®æ—¶æ˜¾ç¤ºï¼‰ï¼š</h3>
        <div id="errorList"></div>
    </div>
  </div>
  
  <!-- å¼•å…¥æ„å»ºåçš„ SDK æ–‡ä»¶ -->
  <script src="./dist/index.umd.js"></script>
  
  <script>
    // ========== JSé”™è¯¯ä¸ŠæŠ¥å™¨ç±» ==========
    class JsErrorReporter {
        constructor(serverUrl){
            this.serverUrl = serverUrl
        }
        async report (data) {
            if(!this.serverUrl){
                console.warn('JSé”™è¯¯ä¸ŠæŠ¥å¤±è´¥ï¼šserverUrlæœªé…ç½®')
                return
            }
            try {
                const response = await fetch(`${this.serverUrl}/js-errors`,{
                    method:'POST',
                    headers:{
                        'Content-Type':'application/json'
                    },
                    body:JSON.stringify(data),
                    keepalive:true
                })
                if(!response.ok){
                    console.warn('JSé”™è¯¯ä¸ŠæŠ¥å¤±è´¥ï¼š',response.statusText)
                }
            } catch (error) {
                console.warn('JSé”™è¯¯ä¸ŠæŠ¥å¤±è´¥',error)
            }
        }
    }

    // ========== JSé”™è¯¯ç›‘æ§åˆå§‹åŒ–å‡½æ•° ==========
    function initJsErrorMonitoring(serverUrl) {
      const reporter = serverUrl ? new JsErrorReporter(serverUrl) : null
      
      // å…¨å±€ JS é”™è¯¯ç›‘å¬
      window.onerror = (message, source, lineno, colno, error) => {
        const errorInfo = {
          type: 'js-error',
          message: typeof message === 'string' ? message : String(message),
          source: source || '',
          lineno: lineno || 0,
          colno: colno || 0,
          stack: error instanceof Error ? error.stack || '' : ''
        }
        
        // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        displayError(errorInfo)
        
        if (reporter) {
          reporter.report(errorInfo)
        } else {
          console.log('ğŸš¨ æ•è·åˆ°é”™è¯¯ï¼ˆæœªé…ç½®ä¸ŠæŠ¥åœ°å€ï¼‰:', errorInfo)
        }
        return true
      }
      
      // Promise æœªæ•è·é”™è¯¯ç›‘å¬
      window.addEventListener('unhandledrejection', (event) => {
        const reason = event.reason
        const errorInfo = {
          type: 'unhandled-rejection',
          message: reason instanceof Error ? reason.message : String(reason),
          source: '',
          lineno: 0,
          colno: 0,
          stack: reason instanceof Error ? reason.stack || '' : ''
        }
        
        // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        displayError(errorInfo)
        
        if (reporter) {
          reporter.report(errorInfo)
        } else {
          console.log('ğŸš¨ æ•è·åˆ°æœªæ•è·é”™è¯¯ï¼ˆæœªé…ç½®ä¸ŠæŠ¥åœ°å€ï¼‰:', errorInfo)
        }
      })
    }

    // ========== åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯ ==========
    function displayError(errorInfo) {
      const errorList = document.getElementById('errorList')
      const errorDiv = document.createElement('div')
      errorDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: white; border-left: 4px solid #ff4d4f; border-radius: 4px;'
      errorDiv.innerHTML = `
        <strong>ç±»å‹:</strong> ${errorInfo.type}<br>
        <strong>æ¶ˆæ¯:</strong> ${errorInfo.message}<br>
        <strong>æ–‡ä»¶:</strong> ${errorInfo.source || 'æœªçŸ¥'}<br>
        <strong>è¡Œå·:</strong> ${errorInfo.lineno}<br>
        <strong>å †æ ˆ:</strong><br>
        <pre style="background: #f0f0f0; padding: 5px; overflow-x: auto; font-size: 12px;">${errorInfo.stack || 'æ— å †æ ˆä¿¡æ¯'}</pre>
        <small>æ—¶é—´: ${new Date().toLocaleTimeString()}</small>
      `
      errorList.insertBefore(errorDiv, errorList.firstChild)
    }

    // ========== åˆå§‹åŒ–é”™è¯¯ç›‘æ§ï¼ˆä¸ä¼  serverUrlï¼Œåªåœ¨æ§åˆ¶å°æ˜¾ç¤ºï¼‰ ==========
    initJsErrorMonitoring()

    // ========== åˆå§‹åŒ– API é”™è¯¯ç›‘æ§ ==========
    // åˆ›å»º API é”™è¯¯ç›‘æ§å®ä¾‹ï¼Œé…ç½®é”™è¯¯å›è°ƒæ¥æ˜¾ç¤ºé”™è¯¯
    // æ³¨æ„ï¼šSDK æ„å»ºåçš„å…¨å±€å¯¹è±¡æ˜¯ OpenTrackerSDK
    let apiErrorMonitor = null
    
    // ç­‰å¾… SDK åŠ è½½å®Œæˆåå†åˆå§‹åŒ–
    if (typeof OpenTrackerSDK !== 'undefined' && OpenTrackerSDK.ApiErrorMonitor) {
      apiErrorMonitor = new OpenTrackerSDK.ApiErrorMonitor({
        enable: true,
        onApiError: (errorInfo) => {
          console.log('âœ… onApiError å›è°ƒè¢«è°ƒç”¨äº†ï¼Œé”™è¯¯ä¿¡æ¯:', errorInfo)
          // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼ˆå’Œ JS é”™è¯¯ä¸€æ ·ï¼‰
          displayApiError(errorInfo)
        }
      })
      // åˆå§‹åŒ– API é”™è¯¯ç›‘æ§ï¼ˆå¼‚æ­¥æ–¹æ³•ï¼‰
      apiErrorMonitor.init().then(() => {
        console.log('âœ… API é”™è¯¯ç›‘æ§åˆå§‹åŒ–æˆåŠŸ')
      }).catch(error => {
        console.error('âŒ API é”™è¯¯ç›‘æ§åˆå§‹åŒ–å¤±è´¥:', error)
      })
    } else {
      console.error('âŒ OpenTrackerSDK.ApiErrorMonitor æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿ SDK å·²æ­£ç¡®åŠ è½½')
    }

    // ========== JS é”™è¯¯æµ‹è¯•å‡½æ•° ==========
    function testError1() {
      throw new Error('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯ï¼šæ™®é€šé”™è¯¯æŠ›å‡º')
    }

    function testError2() {
      Promise.reject(new Error('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯ï¼šæœªæ•è·çš„ Promise é”™è¯¯'))
    }

    function testError3() {
      // è®¿é—®æœªå®šä¹‰çš„å˜é‡
      console.log(undefinedVariable)
    }

    function testError4() {
      // ä½¿ç”¨ eval æ‰§è¡Œè¯­æ³•é”™è¯¯çš„ä»£ç 
      eval('var x = ;')
    }

    // ========== åœ¨é¡µé¢ä¸Šæ˜¾ç¤º API é”™è¯¯ ==========
    function displayApiError(errorInfo) {
      const errorList = document.getElementById('errorList')
      const errorDiv = document.createElement('div')
      errorDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: white; border-left: 4px solid #ff9800; border-radius: 4px;'
      errorDiv.innerHTML = `
        <strong>ç±»å‹:</strong> APIé”™è¯¯ (${errorInfo.type || 'api-error'})<br>
        <strong>URL:</strong> ${errorInfo.url || 'æœªçŸ¥'}<br>
        <strong>æ–¹æ³•:</strong> ${errorInfo.method || 'æœªçŸ¥'}<br>
        <strong>çŠ¶æ€ç :</strong> ${errorInfo.status !== undefined ? errorInfo.status : 'æœªçŸ¥'}<br>
        <strong>çŠ¶æ€æ–‡æœ¬:</strong> ${errorInfo.statusText || 'æœªçŸ¥'}<br>
        <strong>é”™è¯¯åç§°:</strong> ${errorInfo.errorName || 'æœªçŸ¥'}<br>
        <strong>æŒç»­æ—¶é—´:</strong> ${errorInfo.duration || 0}ms<br>
        <small>æ—¶é—´: ${new Date().toLocaleTimeString()}</small>
      `
      errorList.insertBefore(errorDiv, errorList.firstChild)
    }

    // ========== API é”™è¯¯æµ‹è¯•å‡½æ•° ==========
    async function testApiError1() {
      // æµ‹è¯• 404 é”™è¯¯
      try {
        await fetch('https://httpbin.org/status/404')
      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error)
      }
    }

    async function testApiError2() {
      // æµ‹è¯• 500 é”™è¯¯
      try {
        await fetch('https://httpbin.org/status/500')
      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error)
      }
    }

    async function testApiError3() {
      // æµ‹è¯•ç½‘ç»œé”™è¯¯ï¼ˆè®¿é—®ä¸å­˜åœ¨çš„åœ°å€ï¼‰
      try {
        await fetch('https://this-domain-does-not-exist-12345.com/api')
      } catch (error) {
        console.error('ç½‘ç»œé”™è¯¯:', error)
      }
    }

    async function testApiError4() {
      // æµ‹è¯•è¶…æ—¶é”™è¯¯
      try {
        const controller = new AbortController()
        const timeoutId = setTimeout(() => controller.abort(), 100) // 100ms è¶…æ—¶
        await fetch('https://httpbin.org/delay/5', {
          signal: controller.signal
        })
        clearTimeout(timeoutId)
      } catch (error) {
        console.error('è¶…æ—¶é”™è¯¯:', error)
      }
    }
  </script>
</body>
</html>